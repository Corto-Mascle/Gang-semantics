\subsection{Construction of an "initial run" from an "unfolding tree"}
\label{app:tree-to-run}

%\LemTreeToRun*
\begin{restatable}{lemma}{LemTreeToRun}
	\label{lem:tree-to-run}
	If there exists an "unfolding tree" over $\prot$ satisfying a "boss specification" $\bossspec \in \messages^*$ then there exists an "initial run" $\run$ of $\prot$ satisfying $\bossspec$.
\end{restatable}

We start by defining "partial runs", which "runs" where some receptions are not matched by broadcasts. Intuitively, this will allow us to build "partial runs" from "unfolding trees" whose root is a "follower node", which implicitely relies on its parent for some broadcasts. We will therefore construct inductively "partial runs" from nodes of the tree; we will obtain complete "runs" by matching reception and broadcasts of different "partial runs".

\begin{definition}
	Let $\config, \config'$ two configurations. 
	
	A ""partial step"" $\config \pstep{} \config'$ is defined if either $\config \step{} \config'$ (normal "step") or there exist $m \in \messages$, $v\in \nats$ such that for all agent $a$ either $\config(a) = \config'(a)$ or $\config(a) \extbr{\delta}{v} \config'(a)$ with $\delta$ a transition receiving "message type" $m$ (""unmatched reception"").
	
	\AP A ""partial run"" is a sequence of "partial steps".
	Note that a "local run" can be seen as a "partial run" with a single agent. A "partial run" is ""initial@@partial"" if it starts in an "initial configuration".
	The \reintro{$v$-input} $\reintro*\vinput{v}{\run}$ of a "partial run" $\run$ is the sequence $m_0 \cdots m_k$ of "message types" corresponding to "unmatched receptions" with value $v$ in $\run$. Its \reintro{$v$-output} $\reintro*\voutput{v}{\run}$ is the sequence of "message types" corresponding to "broadcasts" with value $v$ in $\run$.
\end{definition}


We will prove the following, more general version of Lemma~\ref{lem:tree-to-run}:

\begin{lemma}
\label{lem:tree-to-run-technical}
For every "unfolding tree" $\tree$:
\begin{itemize}
	\item if $\tree$ satisfies a "boss specification" $\bossspec \in \messages^*$, then there exists an "initial run" $\run$ satisfying $\bossspec$,
	\item if $\tree$ satisfies a "follower specification" $(\followwordspec, \followmessagespec)$ then there exist an "initial partial run" $\run$ and a value $v$ such that:
	\begin{itemize}
	\item all "unmatched receptions" in $\run$ are with value $v$,
	\item $\vinput{v}{\run} \subword \followwordspec$, 
	\item $\voutput{v}{\run}$ contains $\followmessagespec$.
	\end{itemize}
\end{itemize}
\end{lemma}

We prove it by induction on the "size" of the "unfolding tree".
Let $\tree$ be a "unfolding tree", let $\node$ be its root.
Let $u := \localrunlabel{\node}$ as a "partial run" with a single agent. Recall that by definition of an "unfolding tree", $u$ starts with distinct values in all its registers, hence it is an "initial partial run".
We will combine $u$ with runs given by children of $\node$ to construct a run $\run$ satisfying the deisred property.
Let $V$ be the set of values appearing in $u$ and $V_{init} \subseteq V$ be the set of "initial@@partial" values of $u$.

\subsubsection{Step 1: "Non-initial Values"}
\label{sec:tree-to-run-step-one}

For each non-initial value $v \ne \valuelabel{\node}$ of $u$, $\node$ has a "boss" child of specification $w$ such that $\vinput{v}{u} \subword w$.
By induction hypothesis, there is an "initial run" $\run'$ satisfying $bw$. Up to renaming agents, assume that $\run$ and $\run'$ have disjoint agents.
We rename values in $\run'$ so that $w$ is broadcast in $\run'$ with value $v$, and $\run'$ has no other shared value with $\run$. 
We use the broadcasts made by $\run'$ to match the "unmatched receptions" with value $v$ in $\run$: this gives us a partial "run" $\run$ with no "unmatched reception" with value $v$ and whose behaviour on other values of $V$ is the same as before.

\subsubsection{Step 2: "Initial Values"}
\label{sec:tree-to-run-step-two}

% We proceed in the same way as in the previous part: the goal is now to use the "partial runs" yielded by the "follower" children to eliminate the "input@@partial" over each "non-initial@@partial" value of $u$, except maybe for $\valuelabel{\node}$, which requires a special case.

Let $v$ be an "initial value" of $u$, and $\decsymb = \\(w_0, m_1, w_1, \ldots, m_\ell, w_\ell)$ the "decomposition" from condition \ref{item:condition2_initial_value}. We have that, for all $j \in \nset{1}{\ell}$, $\node$ has a "follower" child $\node_j$ labelled by $\followlabelmessage{\node_j} = m_j$ and $\followlabelword{\node_j} \in \langdec{\decsymb_j}$ with $\decsymb_j = (w_0, m_1, w_1, \ldots, m_{j-1}, w_{j-1})$. 

Because the behavior of $\run$ with respect to $v$ was not modified by previous steps, it is equal to the one of $u$, hence we can split $\run$ into $\run_0, \ldots, \run_\ell$ with $w_i \subword \voutput{\aval}{\run_i}$ and $\vinput{\aval}{\run_i} \in \set{m_1, \dots, m_{i-1}}^*$ for all $i$. 
By induction hypothesis applied to $\node_j$, for all $j$, there exists an "initial partial run" $\Tilde{\run}_j$ whose only "unmatched receptions" are on $v$, $\vinput{v}{\Tilde{\run}} \subword \followlabelword{\node_{j}}$ and such that $\tilde{\run}_j$ broadcasts $(m_j,v)$ in its last step. Again, we can rename agents and values so that the sets of agents of $\run$ and the $\run_j$ are all disjoint and the only shared value is $v$. 

We can split $\Tilde{\run}_j$ into $\Tilde{\run}_{j, 0}, \ldots, \Tilde{\run}_{j,j-1}$ so that  $\vinput{v}{\Tilde{\run}_{j, i}} \subword \Tilde{w_{j,i}}$ where $\Tilde{w_{j,i}}$ can be obtained by adding letters from $\set{m_1, \ldots, m_j}$ to $w_i$.

We build our new run by induction on $j$. At induction step $j$, we prove that we can combine $\Tilde{\run}_1$ to $\Tilde{\run}_j$ with $\run_0 \cdot \ldots \cdot \run_j$ so that the obtained run $\run'$ has no "unmatched receptions" on value $v$, the same "unmatched receptions" as $\run$ for other values, and that $\run'$ has a broadcast of every $(m_i,v)$ with $i \leq j$. Moreover, this broadcast comes from an agent who has $v$ as non-initial value hence can be duplicated so that we can consider that we have an unlimited supply of messages $(m_i,v)$, $i \leq j$. 

The initialization of our induction simply consists in taking $\run_0$, which has no "unmatched reception" with value $v$. For the induction step, we combine several copies of $\Tilde{\run}_{j+1}$ with $\run'$ so that all "unmatched broadcasts" with value $(m_{j+1},v)$ in $\run$ as now matched in $\run'$. To do so, we may have to duplicate parts of $\run'$ so that "unmatched receptions" in $\Tilde{\run}_{j+1}$ with message $(m_i,v)$ where $i \leq j$ are matched using a copy of $\Tilde{\run}_i$. \nico{en cours}

We can compose each $\run$ with $\Tilde{\run}_{j}$ by running them in parallel over disjoint sets of agents and matching each $\Tilde{\run}_{j, i}$ with $\run_i$ so that the broadcasts of $\run_i$ with value $v$ forming $w_i$ are received in $\Tilde{\run}_{j, i}$ and the only remaining missing broadcasts in that part of the run are of $m_1, \ldots, m_i$.
We obtain a run section whose $v$-"output" still contains $w_i$ and whose "$v$-input" only contains $m_1, \ldots, m_i$. 

Finally, we can use the last operation of $\Tilde{\run}_{j, i}$, which is a broadcast of $m_j$ with value $v$, at any point during the rest of the run, to either extend the $v$-"output" of some $\run_k$ with $k \geq j$ or complete a missing broadcast.
% This construction is illustrated in Figure
% \begin{figure}
% 	\input{../Figures/Fig-tree-to-run}
% 	\caption{An illustration of the composition operation from the proof of Lemma~\ref{lem:tree-to-run}}.
% 	\label{fig:tree-to-run}
% \end{figure}
If $\val = \valuelabel{\node}$ then we have $\bosslabel{\node} \in \langdec{\decsymb}$, and we need to ensure that $\bosslabel{\node}$ is broadcast in $\run$ with value $\val$.
Let $\bossspec_0, \ldots, \bossspec_\ell$ such that $\bosslabel{\node} \subword \bossspec_0\cdots\bossspec_\ell$ and for all $j$, $\bossspec_j$ can be obtained by adding letters from $\set{m_1,\ldots, m_j}$ in $w_j$.
We apply the above composition operation to extend the output of each $\run_{i}$ so that it subsumes $\bossspec_i$ while making sure that its "$\aval$-input" is still only made of $m_1, \ldots, m_i$ with value $v$. 

Then, in all cases, we apply this composition operation to complete the missing broadcasts: while there is a missing broadcast of some letter $m_i$, we compose $\run$ with $\Tilde{\run}_i$ to fill it, while possibly adding some missing broadcasts of $m_1, \ldots, m_{i-1}$.
This procedure terminates as the number of missing broadcasts of $m_\ell, m_{\ell-1}, \ldots, m_1$ decreases for the lexicographic order at each step.

In the end we obtain a run with no missing broadcast on $v$, no missing broadcasts on values outside of $V$ and whose behavior on all other values of $V$ is unaffected. Furthermore if $v = \valuelabel{\node}$ then the $v$-"output" resulting run subsumes $\bosslabel{\node}$. We set $\run$ to be this new "run".

We have shown how to complete $u$ into a "partial run" satisfying the "specification" of $\node$ using the "runs" obtained from its "boss" and "follower" children. This proves the lemma by induction on the "unfolding tree" (there is no need for a base case as the construction applies even if $\node$ has no children).