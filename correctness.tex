%\subsection{Soundness}
\label{sec:soundness}

%\begin{lemma}[Strong copycat]\label{lem:strong-copycat}
%	Let $q \in Q$ and  $\run : \config_0 \step{*} \config_f$ an "initial run"  that covers $q$. Write $\agents := \agentsof{\run}$. There exists $\agents' \subseteq \nats$ finite, a bijection $\psi : \agents \to \agents'$ and a "run" $\run': \config_0' \step{*} \config_f'$ over $\agents \cup \agents'$ such that:
%	\begin{itemize}
%		\item for all $a \in \agents$, $\config_f'(a) = \config_f(a)$ (agents of $\agents$ behave the same in $\run$ and $\run'$),
%		\item for all $a' \in \agents'$, $\st{\config_f'}(a') = \st{\config_f}(\psi^{-1}(a'))$,
%		\item for all $a \in \agents$, either $\data{\config_f}(a) = \data{\config_0}(a)$ and $\data{\config_f'}(a') = \data{\config_0'}(a')$ or $\data{\config_f'}(\psi(a)) = \data{\config_f'}(a)$.
%	\end{itemize}
%\end{lemma}
%
%\begin{proof}
%	Let $\agents' \subseteq \nats$ such that $|\agents'|= |\agents|$ and $\agents \cap \agents' = \emptyset$. 
%	There exists a bijection $\psi: \agents \mapsto \agents'$. Let $M = 1+ \max\set{\data{\config_0}(a) \mid a \in \agents}$.
%	Let $\config_0'$ an initial configuration over $\agents \cup \agents'$ which is equal to $\config_0$ on every agent of $\agents$, and such that $\config'_0(\psi(a)) = \config_0(a) +M$ for all $a \in \agents$. 
%	The constructed "run" $\run'$ over $\agents \cup \agents'$ starts on configuration $\config_0'$. We define it by induction on $\run$.
%	
%	Let $\run = \config_0 \to \config_1 \to \cdots \to \config_n$, let $u = \config_1 \to \cdots \to \config_{n-1}$, suppose we have a run $u' = \config_0' \to \cdots \to \config_{k}'$ over $\agents \cup \agents'$ such that $u$ and $u'$ satisfy the conditions of the lemma.
%	
%	Let $a$ be the broadcasting agent in the last step of $\run$, $m$ the corresponding message.
%	We have $\config_{n-1}(a) = \config_{k}'(a)$.
%	
%	First, we extend $u'$ by making $\psi(a)$ broadcast $m$, and no agent receives it.
%	We obtain a configuration $\config'_{k+1}$, which is equal to $\config'_k$ except that $\psi(a)$ is now in state $\st{\config_{n}}(a)$.
%	
%	Second we make $a$ broadcast $m$ and for all $a_r \in \agents$ that receives the message in $\config_{n-1} \to \config_n$ with an operation $\alpha$, we make both $a_r$ and $\psi(a_r)$ receive it with the same operation.
%	We have to show that this is a correct transition for all $a_r$.
%	
%	\paragraph{First case: $\config_{n-1}(a_r) \neq \config'_{k}(\psi(a_r))$}  Then $a_r$ and $\psi(a_r)$ both still have their initial value, hence the action $\alpha$ cannot be an equality test
%	
%	
%	First we make $a$ broadcast the same message, and 
%	
%	$\psi(a)$ moves in $\run'$ instead, and if the broadcasting agent has register value $v$ in $\run$ then it has value $v+M$ in $\run'$. In this second part, agents of $\agents$ are left idle. Write $\config_f'$ the final configuration of $\run'$. Since agents of $\agents$ behave the same in $\run$ and $\run'$, for all $a \in \agents$, $\config_f(a) = \config_f'(a')$.
%	A straightforward induction shows that this is indeed a correct run, and that in the end of $\run'$ the states and values of agents of $\agents$ are the same as at the end of $\run$, and that for all $a \in \agents$ we have $\config_f'(\psi(a)) = (\st{\config_f}(a), \data{\config_f}(a) +M)$.
%	
%	From this we immediately infer the conditions of the lemma.
%\end{proof}

It is left to prove that our abstraction is sound, in order to do this, consider an abstract run $\aconfiginit \step{\ast} \aconfig = (S, \boss, \clique)$. We shall prove that there exists a concrete run $\run : \config_0 \step{\ast} \config $ such that $\config$ covers all states in $S$, there exists a special agent on state $b$ with value $v$ and for each state $q$ in $\clique$, there is (at least) one agent on $q$ with register value $v$. In order to prove this, we infact prove something stronger: in each of states $s\in S$, we shall prove that we can put an exponential number (in the size of the protocol) of agents in each state $s\in S$ and in each state $k\in \clique$ with value $v$. This stronger property will allow us to do a proof by induction on the length of the run. 

%\begin{lemma}
%	\label{cor:soundness}
%%	For all $\sigma_0 \in \aconfiginitset$ and $\sigma = (S, b, K) \in \Sigma$ such that $\sigma_0 \step{*} \sigma$ there exists a reachable configuration $\gamma$ 
%%	satisfying $K \cup \set{b}$ if $b \neq \noboss$ and $K$ otherwise.
%	For all $\sigma_0 \in \aconfiginitset$ and $\sigma = (S, b, K) \in \Sigma$ such that $\sigma_0 \step{*} \sigma$, for all $s \in S$, there exists a reachable configuration $\gamma$ covering $s$.
%%	satisfying $K \cup \set{b}$ if $b \neq \noboss$ and $K$ otherwise.
%\end{lemma}
%
%\ifproofs
%\begin{proof}
%	We simply apply Lemma~\ref{lem:correctness-construction} to an "abstract run" $\sigma_0 \to \cdots \sigma_n = \sigma$ from $\sigma_0$ to $\sigma$ by setting $i = n$.
%%	We obtain (by setting $i = n$) that there exists a value $v_n$ in the final configuration of the constructed run, for all $s \in K$, there is an agent with value $v_n$ in state $s$. Furthermore, if $b \neq \noboss$, then there is an agent in state $b$ with value $v_n$.  
%\end{proof}
%\fi
