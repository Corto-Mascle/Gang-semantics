\section{Proofs of Proposition~\ref{prop:bound-tree-size}}
\label{app:bound-tree-size}

\begin{restatable}{lemma}{lemBoundLengthHeightH}
	\label{lem:bound-length-at-height-h}
	Let $\prot$ be a protocol, let $\node$ be a node of a "unfolding tree" of minimal size labeled by $\prot$ satisfying a "boss specification" $w$.
	Let $\altmax$ be the maximal "altitude" in $\tau$, let $N = \size{w} + \size{\prot} +r +1$ and let $f_0 : \nats \to \nats$ be the function mapping each $n \in \nats$ to $f_0(n)=(N^2 \towerfun(N,N))^{n+1}$, with $\towerfun$ the function defined in Lemma~\ref{lem:short-local-runs}.
	
	\begin{itemize}
		\item If $\node$ is a "boss node" then $\size{\bosslabel{\node}} \leq f_0(\altmax - \altitude{\node})$ and $\size{\localrunlabel{\node}} \leq f_0(\altmax - \altitude{\node}+1)$.
		
		\item If $\node$ is a "follower node" then $\size{\followlabelword{\node}} \leq \size{\localrunlabel{\node}} \leq f_0(\altmax - \altitude{\node}+1)$.
	\end{itemize} 
\end{restatable}

\begin{proof}
	The proof is by strong induction on $\altmax-\altitude{\node}$.

	%initialization added for clarity although one could factorize it with the rest of the induction
	First, let $\node$ such that $\altitude{\node} = \altmax$. This implies that $\node$ has no follower node (hence we can set $K=0$ in Lemma~\ref{lem:bound-successor-height}).  If $\node$ is the root of the tree, then it is a "boss node" and applying Lemma~\ref{lem:bound-successor-height} proves that $\size{\bosslabel{\node}} \leq \size{w}$ and $\size{\localrunlabel{\node}} \leq \towerfun(\size{\prot}+r,r) \size{w} \leq f_0(0)$ ($\towerfun$ defined in Lemma~\ref{lem:short-local-runs} is of course monotone for both arguments). If $\node$ is not the root of the tree, then it is necessarily a "follower node", and the application of Lemma~\ref{lem:bound-successor-height} again yields that $\size{\followlabelword{\node}} \leq \size{\localrunlabel{\node}} \leq \towerfun(\size{\prot}+r,r) \leq f_0(0)$.   

	Let $\node$ be a node, and suppose that the statement is true for all nodes of altitude greater than $\altitude{\node}$ and that $\altitude{\node} < \altmax$. 
	Let $\node_1, \ldots, \node_k$ be its "follower" children, and $K$ the maximum of all $\size{\followlabelword{\node_i}}$.  By induction hypothesis for all $i$ we have 
	$\size{\followlabelword{\node_i}} \leq f_0(\altmax-\altitude{\node})$ because $\altitude{\node_i} = \altitude{\node}+1$, and thus $K \leq f_0(\altmax-\altitude{\node})$. If $\node$ is not the root of $\tree$ then let $\node'$ be its parent.
	
	Suppose first that $\node$ is a "boss node". If it is at the root then by Lemma~\ref{lem:bound-successor-height}, we have $\size{\bosslabel{\node}} = \size{w} \leq N \leq f_0(\altmax - \altitude{\node})$. If not, $\node'$ is above $\node$ therefore we have $\size{\bosslabel{\node}} \leq \size{\localrunlabel{\node'}} \leq f_0(\altmax - \altitude{\node})$ by Lemma~\ref{lem:bound-successor-height} and induction hypothesis. In both cases we have $\size{\bosslabel{\node}} \leq f_0(\altmax - \altitude{\node})$.	
	Again by Lemma~\ref{lem:bound-successor-height}, we obtain \[\size{\localrunlabel{\node}} \leq (\towerfun(\size{\prot}+r,r)+1) \Big[f_0(\altmax-\altitude{\node}) + \size{\messages}rK\Big]. \]
	
	 As a result, 
	\begin{align*}
	\size{\localrunlabel{\node}}& 
	\leq (\towerfun(\size{\prot}+r,r)+1) f_0(\altmax-\altitude{\node})(\size{\messages} r +1) \\&  
	\leq N^2(\towerfun(N,N) +1) f_0(\altmax - \altitude{\node}) \\& 
	\leq f_0(\altmax - \altitude{\node}+1)
	\end{align*}
	
	Suppose now that $\node$ is a "follower node". By Lemma~\ref{lem:bound-successor-height}, we have 
	$\size{\followlabelword{\node}} \leq \size{\localrunlabel{\node}} \leq (\towerfun(\size{\prot}+r,r)+1) \Big[1+\size{\messages}rK\Big]$.
	By the same argument as above, this proves that $\size{\localrunlabel{\node}} \leq f_0(\altmax - \altitude{\node}+1)$.
\end{proof}




\begin{figure}[h]
	\input{Figures/max-height-bound}
	\caption{Illustration of the proof of Lemma~\ref{lem:bound-max-height}}.
	\label{fig:max-height-bound}
\end{figure}
\begin{restatable}{lemma}{lemBoundMaxHeight}
	\label{lem:bound-max-height}
	There exists a function $f_1$ of the class $\Ffunction{\omega^{\size{\messages}}}$ such that for all "protocol" $\prot$, for all "unfolding tree" $\tree$ of minimal size labeled by $\prot$ satisfying a "boss specification" $w$, the maximal altitude of a node of $\tree$ is bounded by $f_1(\size{\prot} + \size{w}+1)$.
\end{restatable}
\begin{proof}
	Let $\tree$ be a "unfolding tree" of minimal size labeled by $\prot$ satisfying a "boss specification" $w$. Let $\altmax$ be the maximal altitude of a node in $\tree$. Let $\node_0$ the root of the tree, and  $\node_0, \ldots, \node_m$ a branch of the tree going from the root to a node $\node_m$ of altitude $\altmax$ (for all $i$, $\node_i$ is a child of $\node_{i-1}$).
	For all $a \in \nset{1}{\altmax}$, let $j_a$ be the minimal index such that $\altitude{\node_{j_a}} = a$. This index exists as $\altitude{\node_0} = 0$, $\altitude{\node_m} = \altmax$ and for all $i$, $\altitude{\node_{i}} \leq \altitude{\node_{i-1}}+1$.
	Furthermore, for every $a$, for every $j < j_a$, $\altitude{\node_j} < a$. 
	As a consequence, we have $j_1 < j_2 < \ldots < j_{\altmax}$. Moreover, $\node_{j_a}$ is necessarily a "follower node" as otherwise we would have $\altitude{\node_{j_a-1}} = a+1$ which contredicts minimality of $j_a$.
	
	We will bound $\altmax$ using Theorem~\ref{thm:lengthfcttheorem}. For simplicity, we will encode the $\followmessagespec$ part using a fresh character added to our alphabet (this is why we obtain a function in $\Ffunction{w^{\size{\messages}}}$ and not $\Ffunction{w^{\size{\messages}-1}}$; in fact, one could obtain the latter bound using Theorem 5.3. of~\cite{SchmitzS2011upperHigman}, but the proof would be more involved).

	Let $\# \notin \messages$ be a fresh letter, and let $N = \size{w} + \size{\prot}+1$. For all $i \in \nset{1}{\altmax}$ let $\node'_i = \node_{j_{\altmax - i+1}}$ and $w_i = \followlabelword{\node'_{i}} \# \followlabelmessage{\node'_{i}} \in (\messages \cup \set{\#})^*$.
	
	We claim that we cannot have $w_{i_1}\subword w_{i_2}$ for any  $i_1< i_2$.
	Suppose by contradiction that there exist such $i_1$ and $i_2$ with $i_1 < i_2$. Then we would have $\followlabelword{\node'_{i_1}} \subword \followlabelmessage{\node'_{i_2}}$ and $\followlabelmessage{\node'_{i_1}} = \followlabelword{\node'_{i_2}}$.
	Therefore, as $\node_{i_1}$ is a descendant of $\node_{i_2}$, by second case of Lemma~\ref{lem:shortening-branches} there would exist a "unfolding tree" of smaller size than $\tree$ satisfying $w$, contradicting the minimality of $\tree$.
	
	As a result, the sequence $(w_i)_{1\leq i \leq \altmax}$ is a "bad sequence" over the alphabet $\messages\cup\set{\#}$.
	Furthermore, by Lemma~\ref{lem:bound-length-at-height-h}, for all $i$, as $\altitude{\node'_{i}} = \altmax-i+1$, we have $\size{\followlabelword{\node_{j_a}}} \leq f_0(\altmax-i+2) = (N^2(\towerfun(N,N)+1))^{i}$ therefore $\size{w_i} \leq (N^2(\towerfun(N,N)+1))^{i}+2$.
	
	Let $g$ be the function such that $g(n) = (n^2(\towerfun(n,n)+1)) n +2$. By immediate induction, for all $i\geq 1$ we have $g^{(i)}(N) \geq (N^2(\towerfun(N,N)+1))^{i} +2 \geq N$. As a consequence, for all $a$, $\size{w_i} \leq g^{(i)}(N)$ and $g$ is primitive-recursive.
	
	By Theorem~\ref{thm:lengthfcttheorem}, there exists a function $f_1 \in \Ffunction{\omega^{\size{\messages}}}$ such that the sequence $(w_i)_{i \in \nset{1}{\altmax}}$ is of length at most $f_1(N)$. This prove that $\altmax \leq f_1(N) = f_1(\size{\prot} + \size{w} + 1)$.
\end{proof}


The bound on the maximal altitude, along with Lemma~\ref{lem:bound-length-at-height-h}, gives us a bound on the size of the root. 
By using a similar argument as for the maximal altitude, we consider a branch reaching minimal altitude to obtain a "bad" sequence of "boss" nodes and apply the "Length function theorem" again to bound the minimal altitude.



\begin{restatable}{lemma}{lemBoundMinHeight}
	\label{lem:bound-min-height}
	There exists a function $f_2$ of the class $\Ffunction{\omega^{\size{\messages}+1}}$ such that for all "protocol" $\prot$, for all "unfolding tree" $\tree$ of minimal size labeled by $\prot$ satisfying a "boss specification" $w$, the absolute value of the minimal "altitude" of a node of $\tree$ is bounded by $f_2(\size{\prot} + \size{w}+1)$.
\end{restatable}

\begin{proof}
	We proceed similarly as in the proof of Lemma~\ref{lem:bound-max-height}.
	
	Let $\tree$ be a "unfolding tree" of minimal size labeled by $\prot$ satisfying a "boss specification" $w$. Let $\altmin$ be the minimal altitude of a node in $\tree$. Let $\node_0, \ldots, \node_m$ be nodes of $\tree$ such that $\node_0$ is its root, $\altitude{\node_m} = \altmin$, and for all $i\in \nset{1}{m}$, $\node_i$ is a child of $\node_{i-1}$.
	For all $a \in \nset{\altmin}{0}$, let $j_a$ be the minimal index such that $\altitude{\node_{j_a}} = a$. This index exists as $\altitude{\node_0} = 0$, $\altitude{\node_m} = \altmin$ and for all $i$, $\altitude{\node_{i}} \geq \altitude{\node_{i-1}}-1$.
	Furthermore as $j_a$ is the minimal such index, we cannot have $\altitude{\node_j} \leq a$ for any $j < j_a$ as otherwise there would be a $j'$ such that $j' \leq j < j_a$ with $\altitude{\node_{j'}} = a$.
	
	As a consequence, we have $j_0 < j_1 < j_2 < \ldots < j_{\altmin}$. Moreover, $\node_{j_a}$ is necessarily a "boss node" for all $a<0$ as otherwise we would have $\altitude{\node_{j_a-1}} = a-1 \leq a$, and $\node_{j_0}$ is the root and therefore also a "boss node" as $\tau$ satisfies $w$.
	
	Let $N = \size{w} + \size{\prot}+1$. For all $i \in \nset{0}{-\altmin}$ let $\node'_i = \node_{j_{-i}}$ and $w_i = \bosslabel{\node'_{i}} \in \messages^*$.
	
	We claim that we cannot have $w_{i_1}\subword w_{i_2}$ for any  $i_1< i_2$.
	Suppose by contradiction that there exist such $i_1$ and $i_2$ with $i_1 < i_2$. Then we would have $\bosslabel{\node'_{i_1}} \subword \bosslabel{\node'_{i_2}}$, hence, as $\node_{i_2}$ is a descendant of $\node_{i_1}$, by first case of Lemma~\ref{lem:shortening-branches} there would exist a "unfolding tree" of smaller size than $\tree$ satisfying $w$, contradicting the minimality of $\tree$.
	
	As a result, the sequence $(w_i)_{1\leq i \leq \altmax}$ is a "bad sequence" for the "subword order" over the alphabet $\messages\cup\set{\#}$.
	By Lemma~\ref{lem:bound-length-at-height-h}, for all $\node'_i$ we have $\size{\bosslabel{\node'_i}} \leq f_0(\altmax - \altitude{\node'_i}+1) = f_0(\altmax +i+1)$.
	By Lemma~\ref{lem:bound-max-height}, we have $\altmax \leq f_1(N)$ and thus $\size{\bosslabel{\node'_i}} \leq  f_0(f_1(N) +i+1)$
	
	Let $g$ be the function such that $g(n) = (n^2(\towerfun(n,n)+1))n+2$. 
	Let $M = f_0(f_1(N)+1)$. Clearly for all $i\geq 0$ we have $g^{(i)}(M) \geq (N^2(\towerfun(N,N)+1))^{f_1(N) + i}$.
	
	We have $\size{w_0} \leq M = g^{(0)}(N)$ and for all $i>0$, $\size{w_i} \leq (N^2(\towerfun(N,N)+1))^{f_1(N) + i} + 2 \leq (N^2(\towerfun(N,N)+1)) g^{(i-1)}(M) + 2 \leq g^{(i)}(M)$ and $g$ is primitive-recursive.
	
	By definition of the function $f_1 \in \Ffunction{\omega^{\size{\messages}}}$ defined in Lemma~\ref{lem:bound-max-height}, all "bad" sequences of words whose $i$-th term is of length at most $g^{(i)}(M)$ have at most $f_1(M)$ elements.
	
	Hence the sequence $(w_i){1\leq i \leq \altmax}$ cannot have more than $f_1(M)$ elements, thus $\altmin \leq f_1(M) = f_1(f_0(f_1(N)+1))$.
	We define $f_2$ as $f_1 \circ f_0 \circ f_1$. It is a function of $\Ffunction{\omega^{\size{\messages}+1}}$ as $f_0$ and $f_1$ are in $\Ffunction{\omega^{\size{\messages}}} \subseteq \Ffunction{\omega^{\size{\messages}+1}}$ and $\Ffunction{\omega^{\size{\messages}+1}}$ is closed by composition with functions of $\Ffunction{\omega^{\size{\messages}}}$.
\end{proof}

With the bounds on the maximal and minimal altitudes, Lemma~\ref{lem:bound-length-at-height-h} yields a bound on the size of all nodes in the tree.


\begin{lemma}
	\label{lem:bound-node-size}
	There exists a function $f_3$ of the class $\Ffunction{\omega^{\size{\messages}+1}}$ such that for all "protocol" $\prot$, for all "unfolding tree" $\tree$ of minimal size labeled by $\prot$ satisfying a "boss specification" $w$, for all node $\node$ of $\tree$,
	
		\begin{itemize}
		\item $\size{\localrunlabel{\node}} \leq f_3(\size{\prot}+ \size{w})$
			
		\item If $\node$ is a "boss node" then $\size{\bosslabel{\node}} \leq f_3(\size{\prot}+ \size{w})$.
		
		\item If $\node$ is a "follower node" then $\size{\followlabelword{\node}} \leq f_3(\size{\prot}+ \size{w})$.
	\end{itemize} 
\end{lemma}
\begin{proof}
	Using Lemmas~\ref{lem:bound-length-at-height-h}, \ref{lem:bound-max-height} and \ref{lem:bound-min-height}, we obtain that, for every node $\node$, the value $\altmax - \altitude{\node}$ is at most $f_1(\size{\prot} + \size{w} + 1) + f_2(\size{\prot} + \size{w} +1)$. We then apply Lemma~\ref{lem:bound-length-at-height-h} to bounds on $\localrunlabel{\node}$ and $\speclabel{\node}$ by $f_0(f_1(\size{\prot} + \size{w} + 1) + f_2(\size{\prot} + \size{w} +1)+1)$ which is  in $\Ffunction{\omega^{\size{\messages}+1}}$ as $\Ffunction{\omega^{\size{\messages}+1}}$ is closed by composition with elementary functions. We simply define $f_3: n \mapsto f_0(f_1(n+1) + f_2(n+1)+1)$.
\end{proof}

Finally, as we now have a bound on all nodes, we can easily bound the length of branches and the number of children of all nodes to get abound on the total size of the tree.

\PropBoundTreeSize*


\begin{proof}
	Recall that the size of $\tree$ is defined as the sum of the sizes of its nodes. 
	Let $\tree$ be a "unfolding tree" of minimal size labeled by $\prot$ satisfying a "boss specification" $w$. Let $N = \size{\prot} + \size{w}+1$.
	
	We first bound the height of $\tree$ (\emph{i.e.}, the difference between its maximum and minimum "altitude"), then its arity (the maximal number of children of a node), which allows us to obtain a bound on the number of nodes. The sizes of the nodes will finally be bounded using the size of the height. 
	
	By Lemma~\ref{lem:bound-node-size}, for all "boss node" $\node$ in $\tree$ we have $\size{\bosslabel{\node}} \leq f_3(N)$.
	If a branch contains strictly more than $\sum_{i=0}^{f_3(N)}\size{\messages}^{i}$ "follower nodes", then there are two nodes in it with the same "boss" label, hence $\tree$ can be reduced and still satisfy $w$, contradicting the minimality of $\tree$.

	Similarly, by Lemma~\ref{lem:bound-node-size}, for all "follower node" $\node$ in $\tree$ we have $\size{\followlabelword{\node}} \leq f_3(N)$.
	If a branch contains strictly more than $\size{\messages} \sum_{i=0}^{f_3(N)}\size{\messages}^{i}$ "follower nodes", then there are two nodes in it with the same "follower" label, hence $\tree$ can be reduced and still satisfy $w$, contradicting the minimality of $\tree$.
	
	As a result, each branch of $\tree$ contains at most $(\size{\messages}+1) \sum_{i=0}^{f_3(N)}\size{\messages}^{i}$ nodes. We simplify this expression: let $H: n \mapsto n (f_3(n)+1) n^{f_3(n)+1}$, each branch of $\tree$ has less than $H(N)$ nodes.
	
	Furthermore, by Lemma~\ref{lem:bound-successor-height}, each node has at most $\size{\messages}r$ "follower" children. Moreover, if a node $\node$ has more than $f_3(N)$ "boss" children, then one of them can be removed as at most $f_3(N)$ non-initial values appear in $\localrunlabel{\node}$; this would contradict the minimality of $\tree$.	
	As a consequence, each node in $\tree$ has at most $f_3(N) + \size{\messages}(r+1)$ children.

	% Let $\node$ be a node of $\tree$, let $V$ be the set of non-initial values appearing in $\localrunlabel{\node}$ apart from $\valuelabel{\node}$.
	% By condition~\ref{item:condition1_non_initial_value}, for each $v' \in V$, $\node$ has a "boss" child $\node_{v'}$ such that $\vinput{v'}{\localrunlabel{\node}} \subword \bosslabel{\node_{v'}}$.
	% We simply observe that $\size{V} \leq \size{\localrunlabel{\node}}$ as every non-initial value needs to be received at some point in $\localrunlabel{\node}$. We also note that all other "boss" children of $\node$ can be removed, and the resulting tree still satisfies $w$ and is still a "unfolding tree". By minimality of $\tree$, this means that $\mu$ has at most $\size{\localrunlabel{\node}}$ "boss" children, hence at most $f_3(N)$ by Lemma~\ref{lem:bound-node-size}.
	
	By combining the bounds on the size of branches and the arity of nodes, we obtain that $\tree$ has at most $\sum_{h=0}^{H} (f_3(N) + \size{\messages}r)^h$ nodes. Let $G: n \mapsto (H(n)+1)(f_3(n) + n^2)^{H(n)}$. The total number of nodes in $\tree$ is at most $G(N)$.
	
	Finally, we obtain a bound on the size of $\tau$ by taking the product of the bounds on the number of nodes and on the size of each node label: 
	\[ \size{\tree} \leq  G(N) (2 f_3(N)+1)\]
	
	Let $f_4: n \mapsto  G(n) (2 f_3(n) +1)$; using the fact that $n \leq f_3(n)$, we can bound $f_4$ by the composition of an elementary fonction with $f_3$, hence as $f_3 \in \Ffunction{\omega^{\messages}}$ and $\Ffunction{\omega^{\messages}}$ is closed by composition with elementary functions, we have that $f_4 \in \Ffunction{\omega^{\messages}}$.
	Overall, we have shown that the size of a minimal "unfolding tree" satisfying a "boss specification" $w$ and labeled by a "protocol" $\prot$ is bounded by $f_4(\size{\prot} + \size{w} +1)$ with $f_4 \in \Ffunction{\omega^{\size{\messages}}}$.
\end{proof}

